################ DNS #################
- tag: dns_nocn
  type: "fallback"
  args:
    primary: quad9+opendns # 主dns
    secondary: verisign # 备用dns
    threshold: 400 # 无响应切换 毫秒
    always_standby: true # 副可执行插件始终待命

# dns-cn 序列
- tag: dns_cn
  type: "fallback"
  args:
    primary: alidns+dnspod # 主dns
    secondary: 360+trafficroute # 备用dns
    threshold: 100
    always_standby: true # 副可执行插件始终待命

# alidns+dnspod
- tag: alidns+dnspod
  type: forward
  args:
    concurrent: 3
    upstreams:
      - addr: "udp://223.5.5.5:53"
      - addr: "udp://223.6.6.6:53"
      - addr: "udp://2400:3200::1:53"
      - addr: "udp://2400:3200:baba::1:53"
      - addr: "udp://119.29.29.29:53"
      - addr: "udp://119.28.28.28:53"

# 360+trafficroute
- tag: 360+trafficroute
  type: forward
  args:
    concurrent: 3
    upstreams:
      - addr: "udp://101.226.4.6:53"
      - addr: "udp://123.125.81.6:53"
      - addr: "udp://218.30.118.6:53"
      - addr: "udp://140.207.198.6:53"
      - addr: "udp://180.184.1.1:53"
      - addr: "udp://180.184.2.2:53"

# quad9+opendns
- tag: quad9+opendns
  type: forward
  args:
    concurrent: 3
    upstreams:
      - addr: "https://dns9.quad9.net/dns-query"
        dial_addr: "149.112.112.9"
      - addr: "https://dns9.quad9.net/dns-query"
        dial_addr: "2620:fe::fe:9"
      - addr: "https://doh.opendns.com/dns-query"
        dial_addr: "208.67.220.222"
      - addr: "https://dns9.quad9.net/dns-query"
        dial_addr: "2620:119:53::53"

# verisign
- tag: verisign
  type: forward
  args:
    concurrent: 3
    upstreams:
      - addr: "https://dns.verisign.com/dns-query"
        dial_addr: "64.6.64.6"
      - addr: "https://dns.verisign.com/dns-query"
        dial_addr: "64.6.65.6"
      - addr: "https://dns.verisign.com/dns-query"
        dial_addr: "2620:74:1c::2:2"
      - addr: "https://dns.verisign.com/dns-query"
        dial_addr: "2620:74:1b::1:1"

################## 数据源 ################
- tag: geoip_cn # CN IP
  type: ip_set
  args:
    files:
      - "/etc/mosdns/rules/geoip_cn.txt"

- tag: geosite_cn # CN 域名
  type: domain_set
  args:
    files:
      - "/etc/mosdns/rules/geosite_cn.txt"

- tag: geosite_gfw # gfw 域名
  type: domain_set
  args:
    files:
      - "/etc/mosdns/rules/geosite_gfw.txt"

- tag: geosite_location-!cn # 非 CN 域名
  type: domain_set
  args:
    files:
      - "/etc/mosdns/rules/geosite_geolocation-!cn.txt"

- tag: geosite_ads-all # 广告域名
  type: domain_set
  args:
    files:
      - "/etc/mosdns/rules/geosite_category-ads-all.txt"

################# 可执行插件 ################
# 缓存 LAN
- tag: cache_lan
  type: cache
  args:
    size: 8192
    lazy_cache_ttl: 86400

# 缓存 WAN
- tag: cache_wan
  type: cache
  args:
    size: 131072
    lazy_cache_ttl: 86400

- tag: ecs
  type: "ecs_handler"
  args:
    forward: true # 是否转发来自下游的 ecs
    preset: 45.207.213.35 # 发送预设 ecs
    send: false # 是否发送 ecs
    mask4: 24
    mask6: 48

# 调整 ttl
- tag: ttl_1m
  type: sequence
  args:
    - exec: ttl 60

- tag: ttl_5m
  type: sequence
  args:
    - exec: ttl 300

- tag: ttl_1h
  type: sequence
  args:
    - exec: ttl 3600

################# 执行策略 ################
- tag: reject_null_domain
  type: sequence
  args:
    - exec: query_summary reject_null_domain
    - exec: $reject_3

- tag: reject_qtype65
  type: sequence
  args:
    - exec: query_summary reject_qtype65
    - exec: $reject_3

- tag: reject_ad
  type: sequence
  args:
    - exec: query_summary reject_adlist
    - exec: $reject_3

- tag: dns_nocn_seq
  type: sequence
  args:
    - exec: query_summary dns_nocn
    - exec: $dns_nocn

- tag: dns_cn_seq
  type: sequence
  args:
    - exec: query_summary dns_cn
    - exec: $dns_cn

- tag: local_seq
  type: sequence
  args:
    - exec: query_summary dns_cn
    - exec: $dns_cn

- tag: fallback_seq # 其他特殊情况统一使用 dns_cn 处理
  type: sequence
  args:
    - exec: query_summary fallback
    - exec: $dns_cn

- tag: other_seq # 其他特殊情况统一使用 dns_cn 处理
  type: sequence
  args:
    - exec: query_summary other
    - exec: $dns_cn

- tag: sequence
  type: sequence
  args:
    - exec: metrics_collector metrics
    - exec: $pre_sequence # 预处理
    - exec: $main_sequence # 主执行序列

# query cn 域名
- tag: query_cn
  type: sequence
  args:
    - exec: $ecs
    - exec: $dns_cn_seq
    - matches: "!resp_ip $geoip_cn" # 响应非 cn ip
      exec: drop_resp # 丢弃

# query nocn 域名
- tag: query_nocn
  type: sequence
  args:
    - exec: $ecs
    - exec: prefer_ipv4
    - exec: $dns_nocn_seq
    - matches: "resp_ip $geoip_cn" # 响应为 cn ip
      exec: drop_resp # 丢弃

- tag: query_gfw
  type: sequence
  args:
    - exec: $dns_nocn

# query fallback
- tag: query_fallback
  type: sequence
  args:
    - exec: $ecs
    - exec: prefer_ipv4
    - exec: $fallback_seq

# query lan
- tag: query_lan
  type: sequence
  args:
    - exec: $cache_lan
    - matches: has_resp # 命中了 lan cache
      exec: return
    - exec: $ecs
    - exec: $local_seq

# 其他所有情况
- tag: query_other
  type: sequence
  args:
    - exec: $ecs
    - exec: $other_seq

- tag: pre_handle
  type: sequence
  args:
    - exec: $ttl_1h # ttl 1h
    - exec: accept # 接受响应,终止流程

- tag: main_handle
  type: sequence
  args:
    - exec: $ttl_5m # ttl 5min
    - exec: accept # 接受响应,终止流程

# pre_sequence 结果处理
- tag: has_resp_pre
  type: sequence
  args:
    - matches: has_resp # 如果 pre 序列已有响应
      exec: goto pre_handle

# main_sequence 结果处理
- tag: has_resp_main
  type: sequence
  args:
    - matches: has_resp # 如果 main 序列已有响应
      exec: goto main_handle